name: Build and Deploy to Cloud Run

on: 
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deploy:
    permissions:
      contents: 'read'
      id-token: 'write'

    runs-on: ubuntu-latest

    steps:

    - name: Checkout code  
      uses: actions/checkout@v4

    - name: Google Auth
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

    - name: Activate Service Account
      run: |
        echo "${{ secrets.GCP_CREDENTIALS }}" > creds.json
        gcloud auth activate-service-account --key-file=creds.json

    - name: Docker Auth 
      uses: 'docker/login-action@v3'
      with:
        username: 'oauth2accesstoken' 
        password: '${{ steps.auth.outputs.access_token }}'
        registry: 'europe-west2-docker.pkg.dev'

    - name: Build and push image
      run: |
        docker build -t 'europe-west2-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/node-template/backend-service:${{ github.sha }}' --build-arg GCP_CREDENTIALS=${{ secrets.GCP_CREDENTIALS }} .
        docker push 'europe-west2-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/node-template/backend-service:${{ github.sha }}'

    - name: Deploy to Cloud Run  
      run: |
        gcloud run deploy node-template-service --image=europe-west2-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/node-template/backend-service:${{ github.sha }} --region=europe-west2 --set-env-vars=SECRET_ID=${{ secrets.SECRET_ID }}
